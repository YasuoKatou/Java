<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="yks.ticket.lite.dao.master.ProjectMasterDao">
  <resultMap id="projectMasterResultMap" type="yks.ticket.lite.entity.master.ProjectMasterEntity" autoMapping="true">
    <association property="manager" columnPrefix="pm_" resultMap="yks.ticket.lite.dao.master.UserMasterDao.userMasterResultMap" />
  </resultMap>

  <insert id="insert">
    insert into m_project (
        id       --識別子
      , name     --プロジェクト名称
      <if test="description != null">
      , description  --プロジェクトの説明
      </if>
      , manager_id  --プロジェクトの管理者
      <if test="opened != null">
      , opened      --公開
      </if>
      , createUserId  --作成者ID
      , versionNo     --バージョンNo
    ) values (
      <if test="id == null">
        coalesce((select max(id) from m_project), 0) + 1
      </if>
      <if test="id != null">
        #{id}
      </if>
      , #{name}
      <if test="description != null">
      , #{description}
      </if>
      , #{manager_id}
      <if test="opened != null">
      , #{opened}
      </if>
      , #{createUserId}
      , 1
    )
  </insert>

  <select id="findProjects" resultMap="projectMasterResultMap">
    select
        PJ.id            --プロジェクト識別子
      , PJ.name          --プロジェクト名称
      , PJ.description   --プロジェクトの説明
      , PJ.manager_id    --プロジェクト管理者
      , PJ.terminated    --プロジェクト完了
      , PJ.opened        --第三者に公開
      , PJ.createDate    --作成日時
      , PJ.createUserId  --作成者ID
      , PJ.updateDate    --更新日時
      , PJ.updateUserId  --更新者ID
      , PJ.versionNo     --バージョンNo
      , U1.name1 pm_name1        --プロジェクト管理者（性）
      , U1.name2 pm_name2        --プロジェクト管理者（名）
    from m_project PJ
    left outer join m_user U1
      on U1.id = PJ.manager_id
    <if test="terminated != null">
    where terminated = #{terminated}
    </if>
    order by name
  </select>
</mapper>