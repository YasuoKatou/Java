<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="yks.ticket.lite.dao.TicketProgressDao">
  <resultMap id="ticketProgressResultMap" type="yks.ticket.lite.entity.TicketProgressEntity" autoMapping="true">
  </resultMap>

  <select id="findByProject" resultMap="ticketProgressResultMap">
    select
        project_id  --プロジェクトID
      , id          --進捗ID
      , disp_seq    --表示順
      , name        --進捗名称
      , versionNo   --バージョンNo
    from t_ticket_progress
    where project_id = #{project_id}
      and available = 'yes'
    order by disp_seq
  </select>

  <update id="setUnavailable">
    update t_ticket_progress set
      available = 'no'
    where project_id = #{project_id}
  </update>

  <insert id="appendItem">
    insert into t_ticket_progress (
        project_id  --プロジェクトID
      , id  --識別子
      , disp_seq  --表示順
      , name  --ステータス名称
      , available  --有効フラグ
      , createDate  --作成日時
      , createUserId  --作成者ID
      , versionNo  --バージョンNo
    ) values (
        #{project_id}
      , #{id}
      , #{disp_seq}
      , #{name}
      , 'yes'
      , CURRENT_TIMESTAMP
      , #{createUserId}
      ,1
    )
  </insert>

  <update id="updateItem">
    update t_ticket_progress set
        disp_seq = #{disp_seq}
      , name = #{name}
      , available = 'yes'
      , updateDate = CURRENT_TIMESTAMP
      , updateUserId = #{updateUserId}
      , versionNo = versionNo + 1
    where project_id = #{project_id}
      and id = #{id}
  </update>

  <select id="getMaxId" resultType="Long">
    select
      coalesce(max(T1.id), 0)
    from t_ticket_progress T1
    where T1.project_id = #{project_id}
  </select>
</mapper>